# 1.8 Azure 부하 분산 장치 만들기
가상 컴퓨터로 서비스를 하다 보면 언젠가 성능이 부족해 지게 되어 '가상 컴퓨터의 크기를 키워야 하는가?' 라는 의문에 도달하게 됩니다. 또한 Azure에서는 현재 프리미엄 디스크를 사용하지 않는 이상 가상 컴퓨터의 가용성에 대한 SLA를 보장하지 않기 때문에 서비스 이중화를 꼭 해야 합니다. 이 때 여러 가상 컴퓨터에 적절히 부하를 분산할 수 있는 부하 분산 장치가 필요하게 되며, 기존 IDC 환경에서는 L4 스위치로 해결하였습니다.

Azure에서는 부하 분산 장치라는 리소스를 활용하여 L4 단계의 부하 분산이 가능합니다. 부하 분산 장치는 무료이며 네트워크 트래픽 비용만 청구 됩니다.

이번 내용에서 Azure 부하 분산 장치를 만들고 가상 컴퓨터를 연결하여 서비스 요청에 대해 L4 단계의 부하 분산을 할 수 있도록 구성해 보겠습니다.
> [!메모]
>
> 이번 내용에서는 Azure CLI 2.0을 사용하는 시나리오가 없습니다.

## 웹 콘솔에서 Azure 부하 분산 장치 만들기
1. [Azure 웹 콘솔 (https://portal.azure.com)](https://portal.azure.com)에 접속합니다.

2. 좌측 메뉴에서 **부하 분산 장치**를 선택합니다.
    - 좌측 메뉴에 **부하 분산 장치**가 없다면, 하단의 More Service를 선택 한 후 **네트워킹** 부분에서 **부하 분산 장치**를 찾아 선택합니다.

3. **부하 분산 장치** 블레이드 창이 뜨면 상단에 **+추가**버튼을 눌러서 **부하 분산 장치**를 생성합니다.

4. **부하 분산 장치 만들기** 블레이드 창이 뜨면 아래와 같이 입력한 후 **만들기**버튼을 클릭하여 **부하 분산 장치**를 만듭니다.
    - `이름`: 표시될 부하 분산 장치의 이름
    - `형식`: **공개**는 외부에서 접속 가능한 **부하 분산 장치**를 만들 때 사용하며 **내부**는 가상 네트워크(또는 사설 네트워크)에서만 접근 가능한 **부하 분산 장치**를 만들 때 사용합니다. 여기서는 **공개**를 선택합니다.
    - `공용 IP 주소`: 외부에서 접근이 가능하도록 공인 IP를 할당합니다. **공용 IP 주소 선택**을 클릭하고 **새로 만들기**를 클릭한 후 **공용 IP 주소 만들기** 블레이드가 뜨면 `이름`에 표시 될 공용 IP 주소 이름을 넣고 `할당`은 **동적**으로 선택 후 **확인**을 클릭합니다.
    - `구독`: 부하 분산 장치를 만들 구독을 선택합니다.
    - `리소스 그룹`: 부하 분산 장치를 만들 리소스 그룹을 선택합니다.
    - `위치`: 부하 분산 장치를 만들 지역을 선택합니다.

5. **부하 분산 장치**가 만들어 졌다는 알람이 뜨면 상단에 **새로 고침**을 클릭하여 만들어진 **부하 분산 장치**를 찾아 클릭합니다.

6. 선택한 **부하 분산 장치** 블레이드 창이 뜨면 왼쪽 메뉴에서 **백 엔드 풀**을 선택 합니다.

7. 상단의 **추가**버튼을 클릭 합니다.

8. **백 엔드 풀 추가** 블레이드 창이 뜨면 아래와 같이 입력한 후 하단에 **확인** 버튼을 클릭 합니다.
    - `이름`: 표시 될 백엔드 풀 이름을 입력합니다.
    - `IP 버전`: **IPv4**와 **IPv6**가 있으며 여기서에선 **IPv4**를 선택 합니다.
    - `다음에 연결됨`: **연결 안 됨** 옵션은 백엔드에 아무것도 연결을 하지 않는 옵션이며, **가용성 집합**은 백엔드 연결에 가용성 집합을 연결하는 옵션이고, **단일 가상 컴퓨터**는 가용성 집합이 설정되어 있지 않은 가상 컴퓨터와 연결할 수 있는 옵션입니다. 여기서는 **가용성 집합**을 선택합니다.
    - `가용성 집합`: `다음에 연결됨`에서 **가용성 집합**을 선택하면 생기는 옵션입니다. 선택하여 생성되어 있는 **가용성 집합**을 선택합니다.
    - `대상 네트워크 IP 구성 추가`: `가용성 집합`에서 생성된 **가용성 집합**을 선택하면 나오는 옵션으로 백 엔드 풀에 가상 머신을 추가하는 옵션입니다. 원하는 가상 컴퓨터를 전부 입력할 때 까지 반복하여 추가합니다.
        - `대상 가상 컴퓨터`: 선택한 **가용성 집합**에 속한 가상 컴퓨터를 선택합니다.
        - `네트워크 IP 구성`: 선택한 **가용성 집합**에 속한 가상 컴퓨터의 네트워크 인터페이스를 선택합니다. 이는 백 엔드 풀에 연결해야 할 네트워크 IP를 선택해야 합니다.

9. **부하 분산 장치** 블레이드 창의 왼쪽 메뉴에서 **상태 프로브**를 선택 합니다.

10. **상태 프로브** 블레이드 창이 뜨면 상단에 **추가** 버튼을 누릅니다.

11. **상태 프로브 추가** 블레이드 창이 뜨면 아래와 같이 입력한 후 하단에 **확인** 버튼을 클릭합니다.
    - `이름`: 표시 될 상태 프로브 이름
    - `프로토콜`: 백엔드 풀에 연결된 리소스가 정상인지 확인 할 프로토콜을 선택합니다. 여기서는 **HTTP**를 선택합니다.
    - `포트`: 백엔드 풀에 연결된 리소스가 정상인지 확인 할 포트를 입력합니다. 여기서는 **80**을 입력합니다.
    - `경로`: 백엔드 풀에 연결된 리소스가 정상인지 확인 할 경로를 입력합니다. 여기서는 **/index.html**을 입력합니다.
    - `간격`: 백엔드 풀에 연결된 리소스가 정상인지 확인 하는 주기(초)를 설정합니다. 기본 값인 **5**를 입력합니다.
    - `비정상 임계값`: 백엔드 풀에 연결된 리소스가 정상인지 확인하는 횟수가 입력한 값 이상 문제 발생 시 연결을 해제합니다. 기본 값인 **2**를 입력합니다.

12. **부하 분산 장치** 블레이드 창의 왼쪽 메뉴에서 **부하 분산 규칙**을 선택 합니다.

13. **부하 분산 규칙** 블레이드 창이 뜨면 상단에 **추가** 버튼을 누릅니다.

14. **부하 분산 규칙 추가** 블레이드 창이 뜨면 아래와 같이 입력한 후 하단에 **확인** 버튼을 클릭합니다.
    - `이름`: 표시 할 부하 분산 규칙의 이름
    - `프런트 엔드 IP 주소`: 부하 분산 장치에 연결된 프런트 앤드 정보입니다. 기본 값을 그대로 둡니다.
    - `프로토콜`: 부하 분산 할 프로토콜을 선택합니다. 여기서는 **TCP**를 선택합니다.
    - `포트`: 부하 분산 장치에 들어오는 포트를 입력합니다. 여기서는 **80**을 입력합니다.
    - `백엔드 포트`: 부하 분산 장치에서 백엔드 풀에 전달될 포트를 입력합니다. 여기서는 **80**을 입력합니다.
    - `백엔드 풀`: 부하 분산 할 백엔드 풀을 선택합니다.
    - `상태 프로브`: 부하 분산시 사용할 프로브(상태 확인)를 선택합니다. `11번`에서 만든 프로브를 선택합니다.
    - `세션 지속성`: 세션 지속성에 대한 옵션을 선택합니다. **없음**은 **해시 기반 배포 모드**이며 **클라이언트 IP**와 **클라이언트 IP 및 프로토콜**은 **소스 IP 선호도 모드** 입니다. 자세한 내용은 [Azure 문서](https://docs.microsoft.com/ko-kr/azure/load-balancer/load-balancer-distribution-mode)를 참고하시기 바랍니다. 여기서는 **없을**을 선택합니다.
    - `유휴 제한 시간(분)`: 유휴 제한시간을 선택합니다. 여기서는 기본 값 그대로 사용합니다.
    - `부동 IP(Direct Server Return)`: 여기서는 조작하지 않습니다.

15. **부하 분산 장치** 블레이드 창의 왼쪽 메뉴에서 **개요**를 선택하여 **공용 IP 주소**를 복사하여 새로운 웹 브라우저에 붙여 넣어 정상적인 통신을 하는지 확인 합니다.
